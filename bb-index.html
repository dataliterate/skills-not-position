<html>
<head>
  <meta charset="utf-8">
  <title>Design Position Generator</title>
  <script src="jquery.min.js"></script>
  <script src="underscore.js"></script>
  <script src="backbone.js"></script>
  <script src="keyboard.js"></script>
<style type="text/css">
label {
  display: block;
  float: left;
  width: 200px;
}
.words {
  float: left;
  width: 100%;
}
.word-group {
  float: left;
  width: 50%;
  height: 250px;
}
ul {
  margin: 0;
  padding: 0;
  list-style: none;
}
li {
  display: block;
  width: 100%;
  margin: 40px 0;
  padding-bottom: 40px;
  border-bottom: 5px solid #CCC;
  float: left;
}
</style>
<script>
var init = function init() {
  var app = window.app = app || {};
  var AppRouter = Backbone.Router.extend({
    routes:{
      '': 'default'
    },
    default: function() {

      app.AppSession = new app.Session();
      app.AppSession.skills = app.AppSkills;
      app.AppSession.words = app.AppWords;
      app.AppMainView = new app.MainView({model: app.AppSession});
      app.AppMainView.render();
    }
  });

  app.Router = new AppRouter();
  app.Skill = Backbone.Model.extend({
    defaults: {
      'title': '',
      'score': 0,
      'quantifiers': []
    },
    test: function() {
    },
    doExport: function() {
      /*
      {
        title: 'you are an experienced (4+) visual designer',
        quantifiers: [
          w('experienced', 10),
          w('visual', 10),
          w('designer', 10)
        ]
      },
      */
      var e = '';
      e += "{\n";
      e += "  title:'" + this.get('title') + "'\n";
      e += "  quantifiers: [\n";
      _.each(this.get('quantifiers'), function(q) {
        e += "    w('" + q[0].get('title') + "', " + q[1] + "),\n";
      });
      e += "  ]\n";
      e += "}\n";
      return e;
    }
  });
  app.Session = Backbone.Model.extend({
    defaults: {
      'skillPos': 0
    },
    words: null,
    skills: null,
    hasNext: function() {
      if(this.get('skillPos') + 1 < app.AppSkills.length) {
        return true;
      }
      return false;
    },
    next: function() {
      this.set('skillPos', this.get('skillPos') + 1);
    },
    getPosition: function() {
      /**
      * analysis
      * - group
      * -- word, score
      * -- word, score
      */
      var analysis = {};
      /*
      var pool = app.AppWords.getWordsByGroup();
      _.each(pool, function(words) {

      });
      */
      app.AppSkills.each(function(skill) {
        var userScore = skill.get('score');
        if(_.isUndefined(userScore)) {
          userScore = 0;
        }
        if(!userScore) {
          return;
        }
        _.each(skill.get('quantifiers'), function(wordFactor) {
          userScore -= 40;
          wordFactor[0].addToScore(userScore * wordFactor[1]);
        });
      });

      var groups = app.AppWords.getGroups();
      var grouped = {};
      console.log(groups);
      _.each(groups, function(group) {
        var words = app.AppWords.getWordsInGroup(group);
        grouped[group] = words;
      });
      /**
      grammar
      --
      Attitude Level [, Level] Field [Field] [Title] Designer
      */
      return _.first(grouped['attitude']).get('title') +
        ' ' + _.first(grouped['level']).get('title') +
        ' ' + _.first(grouped['field']).get('title') +
        ' ' + _.first(grouped['title']).get('title')
        ;
    }
  });
  app.Skills = Backbone.Collection.extend({
    currentSkill: function() {
      return this.at(app.AppSession.get('skillPos'));
    },
    doExport: function() {
      var e = '[';
      this.each(function(skill) {
        e += "{\n";
        e += "  title: '" + skill.get('title') + "'\n";
        e += "  quantifiers: [\n";
        _.each(skill.get('quantifiers'), function(q) {
          e += "    w('" + q[0].get('title') + "', " + q[1] + "),\n";
        });
        e = e.substr(0, e.length - 2) + "\n";
        e += "  ]\n";
        e += "}\n";
      });
      e += ']';
      console.log(e);
    }
  });
  app.MainView = Backbone.View.extend({
    el: '#app',
    appTemplate: _.template($('#app-tmpl').html()),
    /*
    events: {
      'keypress #app': 'onKeyDown'
    },
    */
    skillView: null,
    initialize: function() {
      this.$el = $(this.el);

      this.listenTo(this.model, 'change:skillPos', this.skillChange);
      $('body').keydown(_.bind(this.onKeyDown, this));
    },
    render: function() {
      this.$el.html(this.appTemplate());
      this.skillChange();
      this.setupView();
    },
    eventLog: {},
    onKeyDown: function(e) {
      var ENTER_KEY = 13;
      if(e.keyCode == ENTER_KEY) {
        this.submitScore();
        return;
      }
      // up, down, shift+up, shift+down

      // numeric input
      var num = null;
      if(!isNaN(String.fromCharCode(e.keyCode))) {
        num = parseInt(String.fromCharCode(e.keyCode));
      } else if(!isNaN(String.fromCharCode(e.keyCode - 48))) {
        num = parseInt(String.fromCharCode(e.keyCode - 48));
      }
      if(num === null) {
        return;
      }
      var score = num;
      // photoshop opacity layer style input
      if("lastEvent" in this.eventLog && e.timeStamp - this.eventLog.lastEvent.timeStamp < 250) {
        num = this.eventLog.lastNum.toString() + num.toString();
        this.eventLog.lastNum = num;
      } else {
        this.eventLog.lastNum = num;
        num = num * 10;
      }
      this.eventLog.lastEvent = e;
      

      this.changeScore(num);
    },
    changeScore: function(score) {
      app.AppSkills.currentSkill().set({score: score});
    },
    submitScore: function() {
      //if last skill saved
      if(!this.model.hasNext()) {
        this.showPosition();
        return;
      }
      this.model.next();
    },
    skillChange: function() {
      this.skillView = new app.SkillView({model: app.AppSkills.currentSkill()});
      this.skillView.$el = this.$el.find('#skill');
      this.skillView.render();
    },
    showPosition: function() {
      var position = this.model.getPosition();
      alert(position);
    },
    setupView: function() {
      this.setupView = new app.SetupView({model: this.model});
      this.setupView.$el = this.$el.find('#setup');
      this.setupView.render();
    }
  });
  app.SetupView = Backbone.View.extend({
    template: _.template($('#setup-tmpl').html()),
    views: [],
    initialize: function() {
      
    },
    render: function() {
      this.$el.html(this.template(this.model.toJSON()));
      this.model.skills.each(_.bind(function(skillModel) {
        var skillSetupView = new app.SetupSkillView({model: skillModel});
        this.views.push(skillSetupView);
        skillSetupView.render()
        this.$el.find('ul').append(skillSetupView.el);
      }, this));
      
    },
    updateScore: function() {
      this.$el.find('input').val(this.model.get('score'));
    }
  });
  app.SetupSkillView = Backbone.View.extend({
    template: _.template($('#setup-skill-tmpl').html()),
    events: {
      'change input': 'inputChange'
    },
    initialize: function() {
      
    },
    render: function() {
      this.$el = $('<li></li>');
      var data = this.model.toJSON();
      data.skillid = '';
      data.words = this.getWordsInterface();
      this.$el.html(this.template(data));
      this.el = this.$el;
      this.delegateEvents();
    },
    getWordsInterface: function() {
      console.log(this.model);
      // DUCK TAPE PROGRAMMING::
      var grouped = app.AppSession.words.getWordsByGroup();
      var html = '';
      var that = this;
      _.each(grouped, function(words, group) {
        html += '<div class="word-group"><h4>' + group + '</h4>';
        _.each(words, function(word) {
          var value = 0;
          value = that.getQuantifier(word);
          html += '<label>' + word.get('title') + '</label>';
          html += '<input name="' + word.get('title') + '" type="range" min="0" max="10" step="1" value="' + value + '"><br />';
        })
        html += '</div>';
      });
      return html;
    },
    getQuantifier: function(word) {
      var quantifiers = this.model.get('quantifiers');
      var v = 0;
      _.each(quantifiers, function(q) {
        if(q[0].get('title') == word.get('title')) {
          v = q[1];
        }
      });
      return v;
    },
    setQuantifier: function(word, score) {
      var quantifiers = this.model.get('quantifiers');
      var newQuantifiers = [];
      var v = 0;
      var set = false;
      _.each(quantifiers, function(q) {
        if(q[0].get('title') == word) {
          q[1] = score;
          set = true;
        }
        newQuantifiers.push([q[0], q[1]]);
      });
      if(!set) {
        newQuantifiers.push([app.AppWords.getByTitle(word)[0], score]);
      }
      this.model.set({'quantifiers': newQuantifiers});
    },
    inputChange: function(e) {
      var $input = $(e.currentTarget);
      var name = $input.attr('name');
      this.setQuantifier($input.attr('name'), $input.val());
    }
  });
  app.SkillView = Backbone.View.extend({
    template: _.template($('#skill-tmpl').html()),
    initialize: function() {
      this.listenTo(this.model, "change:score", this.updateScore);
    },
    render: function() {
      this.$el.html(this.template(this.model.toJSON()));
    },
    updateScore: function() {
      this.$el.find('input').val(this.model.get('score'));
    }
  });

  /**
  grammar
  --
  Attitude Level [, Level] Field [Field] [Title] Designer
  */
  app.Word = Backbone.Model.extend({
    defaults: {
      'title': '',
      'group': '',
      'score': 0,
      'n': 0
    },
    addToScore: function(score) {
      console.log("Adding Score " + this.get('title') + " : " + score);
      this.set({'score': this.get('score') + score}, {'n': this.get('n') + 1});
    }
  });
  app.Words = Backbone.Collection.extend({
    addWordsToGroup: function(titles, group) {
      _.each(titles, _.bind(function(title) {
        this.add(new app.Word({title: title, group: group}));
      }, this));
    },
    getByTitle: function(title) {
      return this.filter(function(model) {
        return (model.get('title').toLowerCase() == title.toLowerCase());
      });
    },
    getWordsByGroup: function() {
      return this.groupBy(function(word) {
        return word.get('group');
      });
    },
    getGroups: function() {
      return _.map(this.getWordsByGroup(), function(x, k) {return k});
    },
    getWordsInGroup: function(group) {
      var words = this.getWordsByGroup()[group];
      var sortedWords = _.sortBy(words, function(word) {
        return -1 * (word.get('score') / word.get('n'));
      })
      return sortedWords;
    }
  });
  app.AppWords = new app.Words();

/**
  Attitudes:
    Enthusiastic, Motivated, Open-minded, Critical
    Innovating, Refelcted
  Level:
    Senior level, Junior level, Experienced, Lead, Head of
  Field:
    UX, UI, IxD, Visual, Frontend, Product, Multiscreen
  Title:
    Architect, Evanglist
  */
  app.AppWords.addWordsToGroup('Enthusiastic, Motivated, Open-minded, Open, Critical, Innovative, Refelcted, Technology-Loving'.split(', '), 'attitude');
  app.AppWords.addWordsToGroup('Senior level, Junior level, Experienced, Lead, Head of'.split(', '), 'level');
  app.AppWords.addWordsToGroup('UX, UI, IxD, Visual, Frontend, Product, Multiscreen'.split(', '), 'field');
  app.AppWords.addWordsToGroup('Architect, Evanglist, Designer, Coder, Engineer'.split(', '), 'title');
  
  function w(title, quotient) {
    return [app.AppWords.getByTitle(title)[0], quotient];
  }

  app.AppSkills = new app.Skills([
    {
      title: 'you are an experienced (4+) visual designer',
      quantifiers: [
        w('experienced', 10),
        w('visual', 10),
        w('designer', 10)
      ]
    },
    {
      title: 'you are good in leading a team',
      quantifiers: [
        w('Lead', 10),
      ]
    },
    {
      title: 'you are able to develop visual languages, from idea to product',
      quantifiers: [
        w('Visual', 10),
        w('Product', 10)
      ]
    },
    {
      title: 'your create stunning interfaces for large HDTVs, tiny mobile phones and everything in between (and beyond!)',
      quantifiers: [
        w('Visual', 7),
        w('UI', 10),
        w('Multiscreen', 10)
      ]
    },
    {
      title: 'you share your own ideas and opinion on a blog, on codepen.io, github or twitter',
      quantifiers: [
        w('Open', 10),
        w('Innovative', 7),
        w('Evanglist', 7)
      ]
    },
    {
      title: 'you have a passion for interactive design',
      quantifiers: [
        w('UI', 10),
        w('Designer', 10),
      ]      
    },
    {
      title: 'you are able to rethink your design workflow to produce for ever-changing technologies',
      quantifiers: [
        w('Innovative', 10),
        w('Technology-Loving', 10)
      ]      
    },
    {
      title: 'you experiment with CSS3 to create stunning visual results',
      quantifiers: [
        w('Frontend', 10),
        w('Technology-Loving', 6),
        w('Innovative', 6),
        w('Coder', 4),
      ]      
    },
    {
      title: 'you have a strong understanding of web development',
      quantifiers: [
        w('Frontend', 10),
        w('Architect', 8)
      ]      
    }
  ]);
  Backbone.history.start();
};
$(init);

</script>

<div id="app">

</div>
<script type="text/template" id="app-tmpl">
  <header>
    <h1>Design Position Finder</h1>
  </header>
  <div id="skill">

  </div>
  <div id="setup">

  </div>
  <footer>
    <p>
      Keyboard here :)<br>
      a precious tool
    </p>
  </footer>
</script>
<script type="text/template" id="skill-tmpl">
<h2><%= title %></h2>
<input type="text">
</script>
<script type="text/template" id="setup-tmpl">
<h2>Setup</h2>
<ul>
</ul>
</script>
<script type="text/template" id="setup-skill-tmpl">
<div class="<%= skillid %>">
  <h3><%= title %></h3>
  <div class="words">
    <%= words %>
  </div>
</div>
</script>
<script type="text/template" id="result-tmpl">

</script>
<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>')</script>
</body>
</html>